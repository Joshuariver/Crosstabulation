## Pivotter ???????????? ???????????? Pivot??? ???????????? ??? ??????.
# Source:  http://www.pivottabler.org.uk/articles/v01-introduction.html
# Quick Example

rm(list=ls())

# Pivot Table ??? ????????? ????????? ??? ?????? ?????? ???????????? ???????????? ???????????? ?????? ????????? set???
# ????????? ??????.
# An example of a pivot table showing the number of trains operated by 
# different train companies is:

library(pivottabler)
# arguments:  qhpvt(dataFrame, rows, columns, calculations, ...)
qhpvt(bhmtrains, "TOC", "TrainCategory", "n()") # TOC = Train Operating Company 



# Basic Pivot Table

# Suppose we want to answer the question: How many ordinary/express passenger 
# trains did each train operating company (TOC) operate in the three month period?

# The following code will generate the relevant pivot table:

library(pivottabler)
pt <- PivotTable$new()
pt$addData(bhmtrains)
pt$addColumnDataGroups("TrainCategory")
pt$addRowDataGroups("TOC")
pt$defineCalculation(calculationName="TotalTrains", summariseExpression="n()")
pt$renderPivot()



# Constructing the Basic Pivot Table

# ???????????? Pivot Table ??? ????????? ???????????? ?????? ??? ??????.

# produces no pivot table
library(pivottabler)
pt <- PivotTable$new()
pt$addData(bhmtrains)
pt$renderPivot()

# "???????????? ??????"?????? ?????????.




# ???????????? ??? ?????? ????????????.  specify the column headings
library(pivottabler)
pt <- PivotTable$new()
pt$addData(bhmtrains)
pt$addColumnDataGroups("TrainCategory")   #    << **** LINE ADDED **** <<
pt$renderPivot()

# ???????????? ??? ?????? ????????????. specify the row headings
library(pivottabler)
pt <- PivotTable$new()
pt$addData(bhmtrains)
pt$addColumnDataGroups("TrainCategory")
pt$addRowDataGroups("TOC")                #    << **** LINE ADDED **** <<
pt$renderPivot()

# ?????? ????????? ????????? ????????????. ???????????? ?????? R View ????????? ????????? ???????????? ????????????.
# specifying a calculation

library(pivottabler)
pt <- PivotTable$new()
pt$addData(bhmtrains)
pt$addColumnDataGroups("TrainCategory")
pt$addRowDataGroups("TOC")                #     **** LINE BELOW ADDED ****
pt$defineCalculation(calculationName="TotalTrains", summariseExpression="n()")
pt$renderPivot()


# ??? ????????? ?????? ???????????? ??????????????? ????????? ?????? ??????.
# Outputting the Pivot Table as Plain Text

library(pivottabler)
pt <- PivotTable$new()
pt$addData(bhmtrains)
pt$addColumnDataGroups("TrainCategory")
pt$addRowDataGroups("TOC")
pt$defineCalculation(calculationName="TotalTrains", summariseExpression="n()")
pt$evaluatePivot()
pt



# ???????????? ????????? ?????? ????????? ???????????? ????????? ??????.
# Extending the Basic Pivot Table

# ?????? ?????? ?????? ?????? ????????? ????????? ????????? ???????????? ??????.
# First, adding an additional column data group to sub-divide each ???TrainCategory???
#  by ???PowerType???:

library(pivottabler)
pt <- PivotTable$new()
pt$addData(bhmtrains)
pt$addColumnDataGroups("TrainCategory")
pt$addColumnDataGroups("PowerType")    #    << **** CODE CHANGE **** <<
pt$addRowDataGroups("TOC")
pt$defineCalculation(calculationName="TotalTrains", summariseExpression="n()")
pt$renderPivot()


# ?????? ??????????????? ????????? ??? ????????? ????????? ????????? ??????????????? ?????????.
# ????????? ????????? ????????? ??????????????? ??????(CHANGE)?????? ????????? ????????? ???????????? ??? ??????.
# By default, the new data group does not expand the existing ???TrainCategory??? total. 
# However, an additional argument allows the total column to also be expanded:

library(pivottabler)
pt <- PivotTable$new()
pt$addData(bhmtrains)
pt$addColumnDataGroups("TrainCategory")
pt$addColumnDataGroups("PowerType", expandExistingTotals=TRUE) # << ** CODE CHANGE ** <<
pt$addRowDataGroups("TOC")
pt$defineCalculation(calculationName="TotalTrains", summariseExpression="n()")
pt$renderPivot()

# PowerType ??? ???????????? ?????? ????????? ?????? ????????? ????????? ?????? ??????.
# Instead of adding ???PowerType??? as columns, it can also be added as rows:

library(pivottabler)
pt <- PivotTable$new()
pt$addData(bhmtrains)
pt$addColumnDataGroups("TrainCategory")
pt$addRowDataGroups("TOC")
pt$addRowDataGroups("PowerType")    #    << **** CODE CHANGE **** <<
pt$defineCalculation(calculationName="TotalTrains", summariseExpression="n()")
pt$renderPivot()

# ?????? ???????????? ????????? ????????? ?????? ????????? ??? ??????. pivottabler ??? ????????? ?????????
# ????????? ????????? ??????.  ?????? ?????? ????????? ?????? ????????? ????????? ????????? ?????? ??????.
# It is possible to continue adding additional data groups. The pivottabler 
# does not enforce a maximum depth of data groups. For example, adding the 
# maximum scheduled speed to the rows:

library(pivottabler)
pt <- PivotTable$new()
pt$addData(bhmtrains)
pt$addColumnDataGroups("TrainCategory")
pt$addRowDataGroups("TOC")
pt$addRowDataGroups("PowerType")
pt$addRowDataGroups("SchedSpeedMPH")    #    << **** CODE CHANGE **** <<
pt$defineCalculation(calculationName="TotalTrains", summariseExpression="n()")
pt$renderPivot()


# ?????????????????? ???????????? ?????????, ?????? ??????????????? total ?????? ???????????? ??????.
# addTotal ?????? ???????????? total ?????? ??????????????? ?????? ??? ??????.
# Total ?????? totalCaption ?????? ???????????? ????????? ????????? ??? ??????.
# ????????? ????????? ????????????.
#  As more data groups are added, the pivot table can seem overwhelmed with totals. 
# It is possible to selectively show/hide totals using the addTotal argument. 
# Totals can be renamed using the totalCaption argument. 
# Both of these options are demonstrated below.

library(pivottabler)
pt <- PivotTable$new()
pt$addData(bhmtrains)
pt$addColumnDataGroups("TrainCategory")
pt$addRowDataGroups("TOC", totalCaption="Grand Total")    #    << **** CODE CHANGE **** <<
pt$addRowDataGroups("PowerType")
pt$addRowDataGroups("SchedSpeedMPH", addTotal=FALSE)      #    << **** CODE CHANGE **** <<
pt$defineCalculation(calculationName="TotalTrains", summariseExpression="n()")
pt$renderPivot()

# ?????? ??????????????? ????????? ?????? ????????? ??? ??? ??????.
# This can then be rendered in outline layout:

library(pivottabler)
pt <- PivotTable$new()
pt$addData(bhmtrains)
pt$addColumnDataGroups("TrainCategory")
pt$addRowDataGroups("TOC",
                    outlineBefore=list(isEmpty=FALSE,
                                       groupStyleDeclarations=list(color="blue")),
                    outlineTotal=list(groupStyleDeclarations=list(color="blue")))
pt$addRowDataGroups("PowerType", addTotal=FALSE)
pt$addRowDataGroups("SchedSpeedMPH", addTotal=FALSE)
pt$defineCalculation(calculationName="TotalTrains", summariseExpression="n()")
pt$renderPivot()




# Outline Layout

# ??? ?????? ????????? ????????? ???????????? ???????????? ??? ??????.
# Outline layout renders row data groups as headings:
# Outline layout renders row data groups as headings:

library(pivottabler)
pt <- PivotTable$new()
pt$addData(bhmtrains)
pt$addColumnDataGroups("TrainCategory")
pt$addRowDataGroups("TOC",
                    outlineBefore=list(groupStyleDeclarations=list(color="blue")),
                    outlineAfter=list(isEmpty=FALSE,
                                      mergeSpace="dataGroupsOnly",
                                      caption="Total ({value})",
                                      groupStyleDeclarations=list("font-style"="italic")),
                    outlineTotal=list(groupStyleDeclarations=list(color="blue"),
                                      cellStyleDeclarations=list("color"="blue")))
pt$addRowDataGroups("PowerType", addTotal=FALSE)
pt$defineCalculation(calculationName="TotalTrains", summariseExpression="n()")
pt$renderPivot()


## ???????????? Pivot ????????? ????????? ??????. Quick-Pivot Functions

# qpvt()??? ?????? ???????????? ?????????.
# qpvt() returns a pivot table. Setting a variable equal to the return value, 
# e.g. pt <- qpvt(...), allows further operations to be carried out on the pivot table. 
# Otherwise, using qpvt(...) alone will simply print the pivot table to the console 
# and then discard it.

# qhpvt()??? ?????? ?????? ???????????? HTML ???????????? ???????????? ????????????.
# qhpvt() returns a HTML widget that when used alone will render a HTML representation 
# of the pivot table (e.g. in the R-Studio ???Viewer??? pane).

# qlpvt()??? ?????? ?????? ???????????? LATEX ???????????? ???????????? ????????????.
# qlpvt() returns a Latex representation of a pivot table.


# ?????? ?????? ???????????? ??????????????? ???????????? ?????????????????? ????????? ?????? ?????? ??????.
# library(pivottabler)
qpvt(bhmtrains, "TOC", "TrainCategory", "n()")

# ?????? ??? ????????? ?????? ???????????? ????????? HTML ???????????? ??????????????????, ????????? ???????????? ????????????.
# A slightly more complex pivot table being quickly rendered as a HTML widget, 
# where the calculation headings are on the rows:

library(pivottabler)
qhpvt(bhmtrains, c("=", "TOC"), c("TrainCategory", "PowerType"),
      c("Number of Trains"="n()", "Maximum Speed"="max(SchedSpeedMPH, na.rm=TRUE)"))


# ????????? ????????? ?????? ?????????
# A quick pivot table with a format specified:

library(pivottabler)
qhpvt(bhmtrains, "TOC", "TrainCategory", "mean(SchedSpeedMPH, na.rm=TRUE)", format="%.0f")


# ??? ?????? ???????????? ???????????? ?????? ?????? ????????? ?????? ?????????
# A quick pivot table with two calculations that are formatted differently:

library(pivottabler)
qhpvt(bhmtrains, "TOC", "TrainCategory",
      c("Mean Speed"="mean(SchedSpeedMPH, na.rm=TRUE)", "Std Dev Speed"="sd(SchedSpeedMPH, na.rm=TRUE)"),
      formats=list("%.0f", "%.1f"))



# In the above pivot table, the ???Total??? would be better renamed to something like
#  ???All??? or ???Overall??? since a total for a mean or standard deviation does not 
# make complete sense.

# Totals can be controlled using the totals argument. This works as follows:

# If not specified, then totals are generated for all variables.
# To hide all totals, specify totals=NONE.
# To specify which variables have totals, specify the names of the variables in a character vector, e.g. in a pivot table containing the variables x, y and z, to display totals only for variables x and z, specify totals=c("x", "z").
# To specify which variables have totals and also rename the captions of the total cells, specify a list, e.g. to rename the totals for x to ???All x??? and y to ???All y???, specify totals=list("x"="All x", "y"="All y").
# Returning to the previous quick pivot example, the totals can now be renamed to ???All ?????? using:

library(pivottabler)
qhpvt(bhmtrains, "TOC", "TrainCategory",
      c("Mean Speed"="mean(SchedSpeedMPH, na.rm=TRUE)", "Std Dev Speed"="sd(SchedSpeedMPH, na.rm=TRUE)"),
      formats=list("%.0f", "%.1f"), totals=list("TOC"="All TOCs", "TrainCategory"="All Categories"))




# Further Reading

# The full set of vignettes is:
   
#   Introduction
# Data Groups
# Calculations
# Regular Layout
# Outputs
# Latex Output
# Styling
# Finding and Formatting
# Cell Context
# Navigating a Pivot Table
# Irregular Layout
# Performance
# Excel Export
# Shiny
# Appendix: Details
# Appendix: Calculations
# Appendix: Class Overview


